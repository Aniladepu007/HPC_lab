#include <bits/stdc++.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <pthread.h>
#define endl "\n"
typedef int ll;
using namespace std;

static ll client_socket;

void *runner(void *empty) {
      char fileDetails[256];
      recv(client_socket, &fileDetails, sizeof(fileDetails), 0);
      ll i=0;
      stringstream ss;
      string temp[2];
      ss << fileDetails;
      while(ss >> temp[i++]);

      cout<<fileDetails<<endl;
      string s = "copy_";
      s += temp[0];
      temp[0] = s;
      FILE *fp2=fopen((const char *)temp[0].c_str(),"w");

      vector<string> clientMsg(stoi(temp[1]));
      recv(client_socket, &clientMsg, sizeof(clientMsg), 0);
      cout<<clientMsg[0];
      //fputs(&clientMsg,fp2);
      //fclose(fp2);
      cout<<"Closing connection!\n";
      close(client_socket);
      pthread_exit(0);
}

int32_t main(int count, char* arg[]) {
      ll n = atoi(arg[1]);
      ll sockfd,portNo = 9898;
      sockfd = socket(AF_INET, SOCK_STREAM, 0);
      struct sockaddr_in server_addr;
      server_addr.sin_family = AF_INET;
      server_addr.sin_addr.s_addr = 0; //INADDR_ANY;
      server_addr.sin_port = htons(portNo);

      bind(sockfd, (struct sockaddr *) &server_addr, sizeof(server_addr));
      listen(sockfd ,n+1);

      ll thread_count = 0;
      pthread_t threadPool[n];
      pthread_attr_t attr;
      pthread_attr_init(&attr);
      while(thread_count < n) {
            cout<<"Listening on port :"<<portNo<<endl;
            client_socket = accept(sockfd, NULL, NULL);

            if(client_socket < 0) { cerr<<"Connection failed\n"<<endl; return 0; }
            else { cout << "Connection successful" << endl; }

            pthread_create(&threadPool[thread_count], &attr, runner, NULL);
            thread_count += 1;
      }

      for(ll i=0; i<n; i++) pthread_join(threadPool[i],NULL);
}
